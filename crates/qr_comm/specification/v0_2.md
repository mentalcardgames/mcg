QR-STREAM PROTOCOL SPECIFICATION
Version 0.2 – 01-Sep-2025

---
## 1. Purpose (one sentence)
QR-STREAM is a unidirectional, byte-stream protocol that fragments application packets into variable sized physical frames with at most 1058-bytes.
Frames are broadcasted them as QR-codes at 20 Hz; receivers may read at 20, 40 or 60 Hz and reconstruct packets while tracking global causality with two Mattern vector clocks.

## 2. Terminology & conventions

- 1 byte = 8 bit
- u8 / u16 / ux = unsigned integers of 8 / 16 / x bit.
- All multi-byte integers little-endian unless noted.
- “Frame” = the complete payload inside the QR-Code.
- “Fragment” = logical piece of an application packet carried inside one frame.
- “AP” = Application Packet.

## 3. Limits
- Participants (senders) ≤ 256 → participant-ID encoded in 1 byte.
- Application packets ≤ 2^18 - 384 = 261760 bytes.
- Logical fragments per AP ≤ 256.
- History remembered per participant = 64 application packets.
- Encoding over GF(2^8) → 15 encoded Fragments

## 4. Frame layout (≤ 1059 bytes)

| 0…3    | 4…1027   | 1028…x           |
|--------|----------|------------------|
| Header | Fragment | Encoding Factors |

### 4.1 Header – 4 bytes

| Byte | Bits  | Field                        |
|------|-------|------------------------------|
| 0    | 0…7   | SenderID (participant 0…255) |
| 1    | 8…13  | AP_time (6-bit Mattern time) |
| 1…3  | 14…31 | AP_total_size (u18)          |

### 4.2 Payload – 1024 bytes
- In the **very first fragment** (fragment_index = 0) the first 384 bytes are occupied by the **Mattern-clock block** (§5).
- Remaining bytes of the first fragment and all bytes of later fragments carry pure AP data.

### 4.3 Encoding Factors - ≤ 30 bytes

- Logical fragments are encoded over a GF(2^8) Field
- 31 bytes are not enough to store 256 × 8 bits = 256 bytes
- Instead, an element of GF(2^8) is paired together with the corresponding index
- (8 + 8) * 15 = 240 bits = 30 bytes ≤ 31 Bytes
- It's possible to encode at most 15 fragments in one frame

#### 4.4 Physical alignment a single encoding factor

| Byte | Field               |
|------|---------------------|
| 0    | Factor from GF(2^8) |
| 1    | Fragment index      |

## 5. Mattern-clock block (384 bytes)

Structure:

| Offset | Size [Byte] | Content                                                 |
|--------|-------------|---------------------------------------------------------|
| 0      | 192         | Min-clock vector (oldest unseen AP, u6 per participant) |
| 192    | 192         | Max-clock vector (newest known AP, u6 per participant)  |

Calculation: 2 clocks × 256 participants × log₂(64) bits = 2×256×6 = 3072 bits = 384 bytes.

## 6. Timing

| Side     | Rate            | Notes                    |
|----------|-----------------|--------------------------|
| Sender   | 20 Hz           | One frame per QR update. |
| Receiver | 20 / 40 / 60 Hz | Device-dependent         |

## 7. QR presentation limits

| Version | Modules | ECC | Usable Bytes (after ECC) |
|---------|---------|-----|--------------------------|
| 1       | 21×21   | H   | 7                        |
| 1       | 21×21   | L   | 17                       |
| 26      | 121×121 | L   | 1367                     |
| 26      | 121×121 | M   | 1059                     |
| 40      | 177×177 | H   | 1273                     |
| 40      | 177×177 | L   | 2953                     |


→ at most 1058-byte frame fits into Version 26 with M redundancy.

→ A lower ECC-level at version 26 yields 308 additional bytes.

## 8. User interaction

- Sender: shows continuously cycling QR frames.
- Receiver: points camera; UI shows
  - current fragment progress,
  - Min-clock (oldest packet not yet reconstructed),
  - Max-clock (newest packet known to exist).

## 9. State diagram (informal)

Sender:
Idle → Acquire AP → Fragment → Encode → Show each frame for 50 ms.

Receiver:
Scan → Buffer frames → Decode coded groups → Re-assemble AP → Update clocks → Deliver to application.

## 10. „Milch oder Wein“ switch

- First 13 s after protocol start: operate in “Milch” mode (Broadcast the newest AP in expectation).
- After 13 s: switch to “Wein” mode (Broadcast older Aps in expectation).
- Switch time is based on sender’s clock.

## 11. Security considerations

None at this layer; integrity is implicit by successful AP reassembly.

---