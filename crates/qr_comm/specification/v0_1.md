QR-STREAM PROTOCOL SPECIFICATION
Version 0.1 – 22-Jul-2025

---
## 1. Purpose (one sentence)
QR-STREAM is a unidirectional, byte-stream protocol that fragments application packets into fixed 1031-byte physical frames
(7-byte header + 1024-byte payload) and broadcasts them as QR-codes at 20 Hz;
receivers may read at 20, 40 or 60 Hz and reconstruct packets while tracking global causality with two Mattern vector clocks.

## 2. Terminology & conventions

- 1 byte = 8 bit
- u8 / u16 / ux = unsigned integers of 8 / 16 / x bit.
- All multi-byte integers little-endian unless noted.
- “Frame” = the complete 1031-byte unit shown to the QR generator.
- “Fragment” = logical piece of an application packet carried inside one frame.
- “AP” = Application Packet.

## 3. Limits
- Participants (senders) ≤ 256 → participant-ID encoded in 1 byte.
- Application packets ≤ 2^18 - 384 = 261760 bytes.
- Logical fragments per AP ≤ 256.
- History remembered per participant = 64 application packets.

## 4. Frame layout (1031 bytes)

| 0 - 6  | 7 - 1030 |
|--------|----------|
| Header | PAYLOAD  |


### 4.1 Header – 7 bytes

| Byte | Bits  | Field                                    |
|------|-------|------------------------------------------|
| 0    | 0-7   | SenderID (participant 0…255)             |
| 1    | 8-13  | AP_time (6-bit Mattern time)             |
| 1-3  | 14-31 | AP_total_size (u18)                      |
| 4-6  | 32-55 | Network_coding_fragment_factors (see §6) |

### 4.2 Payload – 1024 bytes
- In the **very first fragment** (fragment_index = 0) the first 384 bytes are occupied by the **Mattern-clock block** (§5).
- Remaining bytes of the first fragment and all bytes of later fragments carry pure AP data.

## 5. Mattern-clock block (384 bytes)

Structure:

| Offset | Size [Byte] | Content                                                  |
|--------|-------------|----------------------------------------------------------|
| 0      | 192         | Min-clock vector (oldest unseen AP, u6 per participant ) |
| 192    | 192         | Max-clock vector (newest known AP, u6 per participant)   |

Calculation: 2 clocks × 256 participants × log₂(64) bits = 2×256×6 = 3072 bits = 384 bytes.

## 6. Fragmentation & encoding

### 6.1 Plain fragments
- Fragment_index 0, 1, 2 are transmitted **uncoded** to guarantee invertibility.

### 6.2 Network-coded fragments
- Afterward a group of 3 random fragments is XOR-coded:
  C = Fᵢ1 ⊕ Fᵢ2 ⊕ Fᵢ3.
- Network_coding_fragment_factors field:
  - 0..7 = first fragment index
  - 8..15 = second fragment index
  - 16..23 = third fragment index

## 7. Timing

| Side     | Rate            | Notes                    |
|----------|-----------------|--------------------------|
| Sender   | 20 Hz           | One frame per QR update. |
| Receiver | 20 / 40 / 60 Hz | Device-dependent         |

## 8. QR presentation limits

| Version | Modules | ECC | Usable Bytes (after ECC) |
|---------|---------|-----|--------------------------|
| 1       | 21×21   | H   | 7                        |
| 1       | 21×21   | L   | 17                       |
| 26      | 121×121 | M   | 1059                     |
| 40      | 177×177 | H   | 1273                     |
| 40      | 177×177 | L   | 2953                     |

→ 1031-byte frame fits into Version 26 with M redundancy.

## 9. User interaction

- Sender: shows continuously cycling QR frames.
- Receiver: points camera; UI shows
  - current fragment progress,
  - Min-clock (oldest packet not yet reconstructed),
  - Max-clock (newest packet known to exist).

## 10. State diagram (informal)

Sender:
Idle → Acquire AP → Fragment → Encode → Show each frame for 50 ms.

Receiver:
Scan → Buffer frames → Plain fragments 0-2 → Decode coded groups → Re-assemble AP → Update clocks → Deliver to application.

## 11. „Milch oder Wein“ switch

- First 13 s after protocol start: operate in “Milch” mode (Broadcast the newest AP in expectation).
- After 13 s: switch to “Wein” mode (Broadcast older Aps in expectation).
- Switch time is based on sender’s clock.

## 12. Security considerations

None at this layer; integrity is implicit by successful AP reassembly.

---